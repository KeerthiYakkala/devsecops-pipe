name: Secret Scanning

on:
  push:
    branches: ['*']
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  gitleaks:
    name: ğŸ” Gitleaks Secret Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: true

      - name: Upload SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: gitleaks
        continue-on-error: true

  trufflehog:
    name: ğŸ” TruffleHog Deep Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ''
          head: ${{ github.ref_name }}
          extra_args: --only-verified
        continue-on-error: true

  custom-patterns:
    name: ğŸ¯ Custom Pattern Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for common secret patterns
        run: |
          echo "## Custom Secret Pattern Scan" >> $GITHUB_STEP_SUMMARY
          
          # Define patterns to search for
          PATTERNS=(
            "(?i)api[_-]?key\s*[:=]\s*['\"][^'\"]{20,}['\"]"
            "(?i)secret[_-]?key\s*[:=]\s*['\"][^'\"]{20,}['\"]"
            "(?i)password\s*[:=]\s*['\"][^'\"]+['\"]"
            "(?i)aws[_-]?access[_-]?key[_-]?id\s*[:=]\s*[A-Z0-9]{20}"
            "(?i)private[_-]?key\s*[:=]"
            "ghp_[a-zA-Z0-9]{36}"
            "gho_[a-zA-Z0-9]{36}"
            "github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}"
          )
          
          FOUND_SECRETS=0
          
          for pattern in "${PATTERNS[@]}"; do
            matches=$(grep -rn -E "$pattern" --include="*.py" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.env*" --include="*.config*" . 2>/dev/null | grep -v ".git" | grep -v "node_modules" || true)
            if [ -n "$matches" ]; then
              echo "### âš ï¸ Potential secrets found with pattern" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$matches" | head -10 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              FOUND_SECRETS=1
            fi
          done
          
          if [ $FOUND_SECRETS -eq 0 ]; then
            echo "âœ… No suspicious patterns found" >> $GITHUB_STEP_SUMMARY
          else
            echo "::warning::Potential secrets found - review the summary"
          fi

      - name: Check .env files existence
        run: |
          echo "## Environment File Check" >> $GITHUB_STEP_SUMMARY
          
          ENV_FILES=$(find . -name ".env*" -not -path "./.git/*" -not -path "./node_modules/*" 2>/dev/null || true)
          
          if [ -n "$ENV_FILES" ]; then
            echo "### âš ï¸ Environment files found in repository" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$ENV_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendation:** Ensure these are in .gitignore and contain no real secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No .env files tracked in repository" >> $GITHUB_STEP_SUMMARY
          fi

  report:
    name: ğŸ“‹ Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, custom-patterns]
    if: always()
    steps:
      - name: Generate Final Report
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # ğŸ” Secret Scanning Summary
          
          | Scanner | Status |
          |---------|--------|
          | Gitleaks | ${{ needs.gitleaks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | TruffleHog | ${{ needs.trufflehog.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Results' }} |
          | Custom Patterns | ${{ needs.custom-patterns.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          
          ---
          
          ## ğŸ›¡ï¸ Best Practices
          
          1. **Never commit secrets** - Use environment variables or secret managers
          2. **Use .gitignore** - Exclude .env, *.pem, *.key files
          3. **Rotate exposed secrets immediately** - If a secret was committed, consider it compromised
          4. **Use GitHub Secrets** - Store sensitive values in repository/organization secrets
          5. **Pre-commit hooks** - Install git-secrets or pre-commit with detect-secrets
          
          EOF
