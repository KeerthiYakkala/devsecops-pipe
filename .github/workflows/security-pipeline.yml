name: DevSecOps Security Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_dast:
        description: 'Run DAST scan (requires running application)'
        required: false
        default: 'false'
        type: boolean
      severity_threshold:
        description: 'Minimum severity to fail (LOW, MEDIUM, HIGH, CRITICAL)'
        required: false
        default: 'HIGH'
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL

env:
  SEVERITY_THRESHOLD: ${{ github.event.inputs.severity_threshold || 'HIGH' }}

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

jobs:
  # ============================================================
  # SECRET SCANNING - Detect leaked credentials and API keys
  # ============================================================
  secret-scan:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning all commits

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30

  # ============================================================
  # SAST - Static Application Security Testing
  # ============================================================
  sast-scan:
    name: ðŸ” SAST Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/ci
            p/default
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Run Semgrep with custom rules
        if: hashFiles('config/semgrep-rules.yml') != ''
        run: |
          pip install semgrep
          semgrep --config config/semgrep-rules.yml --sarif --output semgrep-custom.sarif . || true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      - name: Upload Semgrep report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: "*.sarif"
          retention-days: 30

  # ============================================================
  # DEPENDENCY SCANNING - Check for vulnerable dependencies
  # ============================================================
  dependency-scan:
    name: ðŸ“¦ Dependency Audit
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: python
            path: examples/python-app
            check_file: requirements.txt
          - name: node
            path: examples/node-app
            check_file: package.json
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if ${{ matrix.name }} project exists
        id: check
        run: |
          if [ -f "${{ matrix.path }}/${{ matrix.check_file }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # Python dependency scanning
      - name: Set up Python
        if: matrix.name == 'python' && steps.check.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        if: matrix.name == 'python' && steps.check.outputs.exists == 'true'
        run: pip install pip-audit

      - name: Run pip-audit
        if: matrix.name == 'python' && steps.check.outputs.exists == 'true'
        working-directory: ${{ matrix.path }}
        run: |
          pip-audit -r requirements.txt --format json --output pip-audit.json || true
          pip-audit -r requirements.txt --format cyclonedx-json --output sbom-python.json || true
          
          # Check for HIGH/CRITICAL vulnerabilities
          if pip-audit -r requirements.txt --desc --fix --dry-run 2>&1 | grep -E "(high|critical)" ; then
            echo "::error::HIGH or CRITICAL vulnerabilities found in Python dependencies"
            exit 1
          fi

      # Node.js dependency scanning
      - name: Set up Node.js
        if: matrix.name == 'node' && steps.check.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        if: matrix.name == 'node' && steps.check.outputs.exists == 'true'
        working-directory: ${{ matrix.path }}
        run: |
          npm install --package-lock-only || true
          npm audit --json > npm-audit.json || true
          
          # Generate SBOM
          npx @cyclonedx/cyclonedx-npm --output-file sbom-node.json || true
          
          # Fail on HIGH or CRITICAL
          npm audit --audit-level=high

      - name: Upload dependency reports
        if: always() && steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ matrix.name }}
          path: |
            ${{ matrix.path }}/*-audit.json
            ${{ matrix.path }}/sbom-*.json
          retention-days: 30

  # ============================================================
  # CONTAINER SCANNING - Scan Docker images for vulnerabilities
  # ============================================================
  container-scan:
    name: ðŸ³ Container Security
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: python-app
            path: examples/python-app
          - name: node-app
            path: examples/node-app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check
        run: |
          if [ -f "${{ matrix.path }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          push: false
          load: true
          tags: ${{ matrix.name }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.name }}:scan'
          format: 'sarif'
          output: 'trivy-${{ matrix.name }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          ignore-unfixed: true

      - name: Upload Trivy SARIF to GitHub Security
        if: steps.check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-${{ matrix.name }}.sarif'
          category: 'trivy-${{ matrix.name }}'

      - name: Run Trivy for detailed report
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.name }}:scan'
          format: 'json'
          output: 'trivy-${{ matrix.name }}.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Fail on HIGH/CRITICAL vulnerabilities
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.name }}:scan'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload Trivy reports
        if: always() && steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-${{ matrix.name }}
          path: trivy-${{ matrix.name }}.*
          retention-days: 30

  # ============================================================
  # DAST - Dynamic Application Security Testing
  # ============================================================
  dast-scan:
    name: ðŸŒ DAST Analysis
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' || 
      github.event.inputs.run_dast == 'true'
    needs: [container-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start application with Docker Compose
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker-compose up -d
            sleep 30  # Wait for application to start
          elif [ -f "examples/python-app/Dockerfile" ]; then
            docker build -t test-app:latest examples/python-app
            docker run -d -p 8080:8080 --name test-app test-app:latest
            sleep 15
          else
            echo "No application to scan, skipping DAST"
            exit 0
          fi

      - name: Wait for application health
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1 || \
               curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "Application is ready"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
          echo "Application did not become ready"
          exit 1
        continue-on-error: true

      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: 'config/zap-rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_*.html
          retention-days: 30

      - name: Stop application
        if: always()
        run: |
          docker-compose down 2>/dev/null || true
          docker stop test-app 2>/dev/null || true
          docker rm test-app 2>/dev/null || true

  # ============================================================
  # INFRASTRUCTURE AS CODE SCANNING
  # ============================================================
  iac-scan:
    name: ðŸ—ï¸ Infrastructure Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov for IaC scanning
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: checkov.sarif
          soft_fail: true
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif
          category: checkov
        continue-on-error: true

      - name: Run Trivy for IaC
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-iac.sarif'
        continue-on-error: true

      - name: Upload IaC reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iac-reports
          path: |
            checkov.sarif
            trivy-iac.sarif
          retention-days: 30

  # ============================================================
  # SECURITY GATE - Aggregate results and enforce policy
  # ============================================================
  security-gate:
    name: ðŸš¦ Security Gate
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, dependency-scan, container-scan, iac-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install jq-py pyyaml

      - name: Aggregate Security Results
        id: aggregate
        run: |
          # Initialize counters
          CRITICAL=0
          HIGH=0
          MEDIUM=0
          LOW=0
          FAILED_JOBS=""
          
          # Check job results
          if [ "${{ needs.secret-scan.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}secret-scan,"
            CRITICAL=$((CRITICAL + 1))
          fi
          
          if [ "${{ needs.sast-scan.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}sast-scan,"
          fi
          
          if [ "${{ needs.dependency-scan.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}dependency-scan,"
          fi
          
          if [ "${{ needs.container-scan.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}container-scan,"
          fi
          
          # Parse SARIF files for vulnerability counts
          for sarif in $(find security-reports -name "*.sarif" 2>/dev/null); do
            if [ -f "$sarif" ]; then
              crit=$(cat "$sarif" | jq '[.runs[].results[] | select(.level == "error" and (.properties.security-severity // "0" | tonumber) >= 9)] | length' 2>/dev/null || echo 0)
              high=$(cat "$sarif" | jq '[.runs[].results[] | select(.level == "error" and (.properties.security-severity // "0" | tonumber) >= 7 and (.properties.security-severity // "0" | tonumber) < 9)] | length' 2>/dev/null || echo 0)
              med=$(cat "$sarif" | jq '[.runs[].results[] | select(.level == "warning")] | length' 2>/dev/null || echo 0)
              low=$(cat "$sarif" | jq '[.runs[].results[] | select(.level == "note")] | length' 2>/dev/null || echo 0)
              
              CRITICAL=$((CRITICAL + crit))
              HIGH=$((HIGH + high))
              MEDIUM=$((MEDIUM + med))
              LOW=$((LOW + low))
            fi
          done
          
          # Set outputs
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT
          echo "total=$((CRITICAL + HIGH + MEDIUM + LOW))" >> $GITHUB_OUTPUT

      - name: Generate Security Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # ðŸ”’ Security Scan Summary
          
          ## Vulnerability Counts
          
          | Severity | Count | Status |
          |----------|-------|--------|
          | ðŸ”´ Critical | ${{ steps.aggregate.outputs.critical }} | ${{ steps.aggregate.outputs.critical > 0 && 'âŒ FAIL' || 'âœ… PASS' }} |
          | ðŸŸ  High | ${{ steps.aggregate.outputs.high }} | ${{ steps.aggregate.outputs.high > 0 && 'âŒ FAIL' || 'âœ… PASS' }} |
          | ðŸŸ¡ Medium | ${{ steps.aggregate.outputs.medium }} | âš ï¸ Review |
          | ðŸŸ¢ Low | ${{ steps.aggregate.outputs.low }} | â„¹ï¸ Info |
          
          **Total Issues:** ${{ steps.aggregate.outputs.total }}
          
          ## Job Results
          
          | Job | Status |
          |-----|--------|
          | Secret Scan | ${{ needs.secret-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.secret-scan.result }} |
          | SAST Scan | ${{ needs.sast-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.sast-scan.result }} |
          | Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.dependency-scan.result }} |
          | Container Scan | ${{ needs.container-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.container-scan.result }} |
          | IaC Scan | ${{ needs.iac-scan.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.iac-scan.result }} |
          
          ---
          
          ðŸ“Š Full reports available in workflow artifacts
          ðŸ”— Security alerts visible in GitHub Security tab
          EOF

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ðŸ”’ Security Scan Results
            
            | Severity | Count |
            |----------|-------|
            | ðŸ”´ Critical | ${{ steps.aggregate.outputs.critical }} |
            | ðŸŸ  High | ${{ steps.aggregate.outputs.high }} |
            | ðŸŸ¡ Medium | ${{ steps.aggregate.outputs.medium }} |
            | ðŸŸ¢ Low | ${{ steps.aggregate.outputs.low }} |
            
            **Total:** ${{ steps.aggregate.outputs.total }} issues found
            
            ${{ steps.aggregate.outputs.critical > 0 || steps.aggregate.outputs.high > 0 ? 'âŒ **Merge blocked** - Please fix HIGH and CRITICAL issues before merging.' : 'âœ… **Security gate passed** - No blocking vulnerabilities found.' }}
            
            ðŸ“Š [View full report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Enforce Security Gate
        if: |
          steps.aggregate.outputs.critical > 0 || 
          steps.aggregate.outputs.high > 0 ||
          needs.secret-scan.result == 'failure'
        run: |
          echo "::error::Security gate FAILED - ${{ steps.aggregate.outputs.critical }} Critical, ${{ steps.aggregate.outputs.high }} High vulnerabilities found"
          echo "Failed jobs: ${{ steps.aggregate.outputs.failed_jobs }}"
          exit 1

      - name: Security Gate Passed
        if: |
          steps.aggregate.outputs.critical == 0 && 
          steps.aggregate.outputs.high == 0 &&
          needs.secret-scan.result != 'failure'
        run: |
          echo "âœ… Security gate PASSED"
          echo "Found ${{ steps.aggregate.outputs.medium }} medium and ${{ steps.aggregate.outputs.low }} low severity issues"
